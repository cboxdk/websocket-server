services:
  websocket-server:
    build: .
    ports:
      - "80:80"
      - "8080:8080"
    environment:
      APP_NAME: Cbox WebSocket Server
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: "${APP_KEY}"
      API_ADMIN_TOKEN: "${API_ADMIN_TOKEN}"
      LARAVEL_REVERB: "true"
      REVERB_HOST: "0.0.0.0"
      REVERB_PORT: "8080"
      REVERB_SCALING_ENABLED: "false"
      METRICS_ENABLED: "true"
    volumes:
      - ./storage/reverb/apps.json:/var/www/html/storage/reverb/apps.json
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Redis for cluster mode
  redis:
    image: redis:7-alpine
    profiles: [cluster]
